name: Task Machine Issue Runner

on:
  issue_comment:
    types:
      - created
  issues:
    types:
      - opened
      - edited
      - reopened

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  task-machine:
    name: Run task machine for admin @task requests
    if: |
      github.event.issue.pull_request == null &&
      (
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@task') && github.event.comment.author_association == 'OWNER') ||
        (github.event_name == 'issues' && contains(github.event.issue.body, '@task'))
      )
    runs-on: ubuntu-latest
    env:
      ISSUE_NUMBER: ${{ github.event.issue.number }}
      COMMENT_ID: ${{ github.event.comment.id || '' }}
      TRIGGER_ACTOR: ${{ github.event.comment.user.login || github.event.sender.login }}
      REPOSITORY: ${{ github.repository }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Verify triggering actor is repo admin
        id: admin
        run: |
          permission=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/$REPOSITORY/collaborators/$TRIGGER_ACTOR/permission" \
            --jq '.permission // ""' 2>/dev/null || echo '')
          if [[ "$permission" == "admin" ]]; then
            echo "is_admin=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_admin=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Stop when actor is not admin
        if: ${{ steps.admin.outputs.is_admin != 'true' }}
        run: |
          echo "Skipping because @$TRIGGER_ACTOR lacks admin permission."
          exit 0

      - name: Checkout repository
        if: ${{ steps.admin.outputs.is_admin == 'true' }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        if: ${{ steps.admin.outputs.is_admin == 'true' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Checkout existing issue branch if present
        if: ${{ steps.admin.outputs.is_admin == 'true' }}
        run: |
          set -euo pipefail
          BRANCH_NAME="task-machine-${ISSUE_NUMBER}"
          if git ls-remote --exit-code --heads origin "$BRANCH_NAME" >/dev/null 2>&1; then
            git fetch origin "$BRANCH_NAME"
            if git show-ref --verify --quiet "refs/heads/$BRANCH_NAME"; then
              git checkout "$BRANCH_NAME"
            else
              git checkout -b "$BRANCH_NAME" "origin/$BRANCH_NAME"
            fi
            echo "Found existing branch $BRANCH_NAME; checked out for continued work."
          else
            echo "No existing task-machine branch for issue #$ISSUE_NUMBER. Staying on default branch until changes are ready."
          fi

      - name: Collect full issue conversation
        if: ${{ steps.admin.outputs.is_admin == 'true' }}
        run: |
          mkdir -p "output/${ISSUE_NUMBER}"
          gh issue view "$ISSUE_NUMBER" \
            --json title,body,author,comments \
            --jq '{
              title: .title,
              body: .body // "",
              author: .author.login,
              comments: [(.comments[]? | {author: .author.login, createdAt: .createdAt, body: .body})]
            }' > "output/${ISSUE_NUMBER}/issue_context.json"

          {
            echo "# Issue #$ISSUE_NUMBER ‚Äî $(jq -r '.title' "output/${ISSUE_NUMBER}/issue_context.json")"
            echo
            echo "## Original Post by @$(jq -r '.author' "output/${ISSUE_NUMBER}/issue_context.json")"
            echo
            jq -r '.body' "output/${ISSUE_NUMBER}/issue_context.json"
            echo
            echo "## Comments"
            jq -r '.comments // [] | map("### Comment by @" + .author + " (" + .createdAt + ")\n\n" + (.body // "") + "\n")[]' "output/${ISSUE_NUMBER}/issue_context.json"
          } > "output/${ISSUE_NUMBER}/issue_conversation.md"

      - name: React to @task request with üëÄ
        if: ${{ steps.admin.outputs.is_admin == 'true' }}
        run: |
          if [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            # React to the comment
            gh api \
              -X POST \
              -H "Accept: application/vnd.github.squirrel-girl-preview+json" \
              "/repos/$REPOSITORY/issues/comments/$COMMENT_ID/reactions" \
              -f content='eyes'
          else
            # React to the original issue
            gh api \
              -X POST \
              -H "Accept: application/vnd.github.squirrel-girl-preview+json" \
              "/repos/$REPOSITORY/issues/$ISSUE_NUMBER/reactions" \
              -f content='eyes'
          fi

      - name: Install sst/opencode
        if: ${{ steps.admin.outputs.is_admin == 'true' }}
        run: |
          set -euo pipefail
          INSTALL_DIR="$HOME/.opencode/bin"
          mkdir -p "$INSTALL_DIR"

          TMPDIR="$(mktemp -d)"
          trap 'rm -rf "$TMPDIR"' EXIT
          ZIP_PATH="$TMPDIR/opencode.zip"

          curl -fsSL "https://github.com/sst/opencode/releases/latest/download/opencode-linux-x64.zip" -o "$ZIP_PATH"
          unzip -q "$ZIP_PATH" -d "$TMPDIR"
          install "$TMPDIR/opencode" "$INSTALL_DIR/opencode"

          echo "$INSTALL_DIR" >> "$GITHUB_PATH"

      - name: Configure opencode
        if: ${{ steps.admin.outputs.is_admin == 'true' }}
        env:
          OPENCODE_AUTH_JSON: ${{ secrets.OPENCODE_AUTH_JSON }}
        run: |
          mkdir -p "$HOME/.config/opencode"
          cp .github/opencode/config.json "$HOME/.config/opencode/config.json"
          
          mkdir -p "$HOME/.local/share/opencode"
          echo "$OPENCODE_AUTH_JSON" > "$HOME/.local/share/opencode/auth.json"

      - name: Run task machine pipeline
        if: ${{ steps.admin.outputs.is_admin == 'true' }}
        run: |
          PROMPT_FILE="output/${ISSUE_NUMBER}/issue_conversation.md"
          if [[ ! -f "$PROMPT_FILE" ]]; then
            echo "Conversation file missing: $PROMPT_FILE"
            echo "Contents of output/${ISSUE_NUMBER}:"
            ls -la "output/${ISSUE_NUMBER}/" || echo "Directory does not exist"
            exit 1
          fi
          bash scripts/pipeline_task_machine.sh --file "$PROMPT_FILE" --id "$ISSUE_NUMBER"

      - name: Detect repository changes
        if: ${{ steps.admin.outputs.is_admin == 'true' }}
        id: git-status
        run: |
          # Only detect changes in the output directory
          if git status --porcelain output/ | grep .; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create branch and commit task results
        if: ${{ steps.git-status.outputs.has_changes == 'true' }}
        id: branch
        run: |
          set -euo pipefail
          BRANCH_NAME="task-machine-${ISSUE_NUMBER}"
          if git rev-parse --verify "$BRANCH_NAME" >/dev/null 2>&1; then
            git checkout "$BRANCH_NAME"
          else
            git checkout -b "$BRANCH_NAME"
          fi
          # Only add files from the output directory
          git add output/
          git commit -m "chore: run task machine for issue #$ISSUE_NUMBER"
          git push origin "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> "$GITHUB_OUTPUT"
          
          # Add branch link to issue comment
          BRANCH_URL="https://github.com/${{ github.repository }}/tree/$BRANCH_NAME"
          gh issue comment "$ISSUE_NUMBER" --body "üåø **Branch created**: [\`$BRANCH_NAME\`]($BRANCH_URL)"

      - name: Send Telegram notification
        if: ${{ steps.git-status.outputs.has_changes == 'true' }}
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          REPO="${{ github.repository }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          BRANCH_NAME="${{ steps.branch.outputs.branch_name }}"
          ISSUE_URL="https://github.com/$REPO/issues/$ISSUE_NUMBER"
          BRANCH_URL="https://github.com/$REPO/tree/$BRANCH_NAME"
          WORKFLOW_URL="https://github.com/$REPO/actions/runs/${{ github.run_id }}"
          
          # Escape special characters for MarkdownV2
          ESCAPED_TITLE=$(echo "$ISSUE_TITLE" | sed 's/[-_*\[\]()~`>#+=|{}.!]/\\&/g')
          ESCAPED_REPO=$(echo "$REPO" | sed 's/[-_*\[\]()~`>#+=|{}.!]/\\&/g')
          ESCAPED_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[-_*\[\]()~`>#+=|{}.!]/\\&/g')
          
          MSG=$(printf '%s\n' \
            "ü§ñ *Task Machine completed for $ESCAPED_REPO*" \
            "" \
            "*Issue \\#$ISSUE_NUMBER:* $ESCAPED_TITLE" \
            "*Branch:* [\`$ESCAPED_BRANCH\`]($BRANCH_URL)" \
            "" \
            "*View:* [Issue]($ISSUE_URL) \\| [Branch]($BRANCH_URL) \\| [Workflow]($WORKFLOW_URL)" \
          )
          
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d "chat_id=$TELEGRAM_CHAT_ID" \
            -d "parse_mode=MarkdownV2" \
            -d "text=$MSG" \
            -d "disable_web_page_preview=true"

      - name: Provide answer to latest request
        if: ${{ steps.admin.outputs.is_admin == 'true' }}
        run: |
          PLAN_FILE="output/${ISSUE_NUMBER}/task_machine_plan.md"
          if [[ ! -f "$PLAN_FILE" ]]; then
            echo "Task machine output missing: $PLAN_FILE"
            exit 1
          fi
          gh issue comment "$ISSUE_NUMBER" --body-file "$PLAN_FILE"

  unauthorized:
    name: Notify unauthorized commenters
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request == null &&
      contains(github.event.comment.body, '@task') &&
      github.event.comment.author_association != 'OWNER'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Post unauthorized message
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚ùå @${context.actor} only repository admins can trigger @task. Please ask an admin to run it.`
            });
