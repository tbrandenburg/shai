name: Task Machine Issue Runner

on:
  issue_comment:
    types:
      - created

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  task-machine:
    if: ${{ github.event.issue.pull_request == null && contains(github.event.comment.body, '@task') }}
    runs-on: ubuntu-latest
    env:
      ISSUE_NUMBER: ${{ github.event.issue.number }}
      COMMENT_ID: ${{ github.event.comment.id }}
      COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
      REPOSITORY: ${{ github.repository }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify commenter is repo admin
        id: admin
        run: |
          permission=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/$REPOSITORY/collaborators/$COMMENT_AUTHOR/permission" \
            --jq '.permission // ""')
          if [[ "$permission" == "admin" ]]; then
            echo "is_admin=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_admin=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Stop when commenter is not admin
        if: ${{ steps.admin.outputs.is_admin != 'true' }}
        run: |
          echo "Skipping because @$COMMENT_AUTHOR lacks admin permission."
          exit 0

      - name: Collect full issue conversation
        if: ${{ steps.admin.outputs.is_admin == 'true' }}
        run: |
          mkdir -p output
          issue_title=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/$REPOSITORY/issues/$ISSUE_NUMBER" \
            --jq '.title')
          issue_author=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/$REPOSITORY/issues/$ISSUE_NUMBER" \
            --jq '.user.login')
          issue_body=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/$REPOSITORY/issues/$ISSUE_NUMBER" \
            --jq '.body // ""')

          {
            echo "# Issue #$ISSUE_NUMBER â€” $issue_title"
            echo
            echo "## Original Post by @$issue_author"
            echo
            echo "$issue_body"
            echo
            echo "## Comments"
            gh api --paginate \
              -H "Accept: application/vnd.github+json" \
              "/repos/$REPOSITORY/issues/$ISSUE_NUMBER/comments" \
              --jq '.[] | "### Comment by @\(.user.login) (\(.created_at))\\n\\n\(.body // \"\")\\n"'
          } > output/issue_conversation.md

      - name: Acknowledge @task request with ðŸ‘€
        if: ${{ steps.admin.outputs.is_admin == 'true' }}
        run: |
          comment_link="https://github.com/$REPOSITORY/issues/$ISSUE_NUMBER#issuecomment-$COMMENT_ID"
          body=$'ðŸ‘€ Tracking the @task request in '"$comment_link"'.'
          gh api \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            "/repos/$REPOSITORY/issues/$ISSUE_NUMBER/comments" \
            -f body="$body"

      - name: Install sst/opencode
        if: ${{ steps.admin.outputs.is_admin == 'true' }}
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> "$GITHUB_PATH"

      - name: Run task machine pipeline
        if: ${{ steps.admin.outputs.is_admin == 'true' }}
        env:
          PROMPT_FILE: output/issue_conversation.md
        run: |
          if [[ ! -f "$PROMPT_FILE" ]]; then
            echo "Conversation file missing"
            exit 1
          fi
          prompt=$(cat "$PROMPT_FILE")
          bash scripts/pipeline_task_machine.sh "$prompt"

      - name: Detect repository changes
        if: ${{ steps.admin.outputs.is_admin == 'true' }}
        id: git-status
        run: |
          if git status --porcelain | grep .; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create branch and commit task results
        if: ${{ steps.git-status.outputs.has_changes == 'true' }}
        env:
          BRANCH_NAME: task-machine/issue-${{ github.event.issue.number }}-${{ github.run_id }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH_NAME"
          git add -A
          git commit -m "chore: run task machine for issue #$ISSUE_NUMBER"
          git push origin "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> "$GITHUB_OUTPUT"

      - name: Provide answer to latest request
        if: ${{ steps.admin.outputs.is_admin == 'true' }}
        run: |
          if [[ ! -f output/task_machine_plan.md ]]; then
            echo "Task machine output missing"
            exit 1
          fi
          gh issue comment "$ISSUE_NUMBER" --body-file output/task_machine_plan.md
